---
title: "Connecting to Google BigQuery with DBplyr"
output: html_notebook
---

## Google Cloud Account & Big Query

1) Get a Google Cloud account

    - [BigQuery sandbox](https://cloud.google.com/bigquery/docs/sandbox)
    - [Google Cloud Free Program](https://cloud.google.com/free/docs/gcp-free-tier)
    - [BigQuery public datasets](https://cloud.google.com/bigquery/public-data)
    - [BigQuery](https://cloud.google.com/bigquery)
    - [GCP-BigQuery Console](https://console.cloud.google.com/bigquery)

No Credit Card?  [Use the BigQuery sandbox](https://cloud.google.com/blog/products/data-analytics/query-without-a-credit-card-introducing-bigquery-sandbox) 



This example uses [Kevin Wang's article on BigQuery in R](https://kevinwang09.github.io/post/bigquery-in-r/) as a starting point.  In this example we will query [JHU's Covid19](https://github.com/CSSEGISandData/COVID-19) public dataset 


## Library packages

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(DBI) 
library(bigrquery)
```


BigQuery refers to tables in the format `database.dataset.table`. For example, you can run this query in the BigQuery Console

```
select * from bigquery-public-data.stackoverflow.users limit 10;
```

## Establish a database connection

First create a new GCP project in the GCP.
The `dbConnect()` argument, `billing`, should have the value of a GCP **project ID**

GPC > Home > Dashboard
GPC > BigQuery

```{r}
# library(DBI)

con <- dbConnect(
  bigquery(),
  project = "bigquery-public-data",
  dataset = "covid19_jhu_csse",
  billing = "workshop-rfun-2021-spring"
)
con
```

Now, from **within the R console**, authenticate with GCP

```
bigrquery::bq_auth()
```
## Create a pointer to the a Google BQ database

Our goal is to investigate the  search the JHU COVID19 _summary_ table.  i.e. bigquery-public-data.covid19_jhu_csse.summary


```{r}
my_db_pointer <- tbl(con, "summary")
```


Now I can use dplyr verbs to explore the dataset.  Using my 

```{r}
# roughly:  SELECT * FROM bigquery-public-data.covid19_jhu_csse.summary limit 10;
glimpse(my_db_pointer)
```


```{r}
# roughly:  SELECT count( * ) FROM summary
count(my_db_pointer)
```



## SQL

Using `DBI`, can compose SQL directly.

```
{r}
DBI::dbGetQuery(con, 
"SELECT *
FROM `bigquery-public-data.covid19_jhu_csse.summary`
LIMIT 10;")
```

### Examples of a more complex SQL query
```
{r}
jhu_covid19_nc_counties_10 <- dbGetQuery(con,
           "SELECT
              admin2, province_state, confirmed
            FROM
              `bigquery-public-data.covid19_jhu_csse.summary` 
            WHERE 
              country_region = 'US'
              AND date = '2020-06-30'
              AND province_state = 'North Carolina'
            LIMIT 10;"
)
jhu_covid19_nc_counties_10
```


```
{r}
jhu_covid19_nc_counties <- dbGetQuery(con,
           "SELECT
              admin2, province_state, confirmed
            FROM
              `bigquery-public-data.covid19_jhu_csse.summary` 
            WHERE 
              country_region = 'US'
              AND date = '2020-06-30'
              AND province_state = 'North Carolina'"
)
jhu_covid19_nc_counties
```

### DBplyr approach

If you don't know SQL, or are more fluent in `dplyr`, you can compose your queries with `dbplyr`.

First make a connection....

```{r}
covid_data_DBplyr_style <- tbl(con, "summary") 
```

an SQL query BUT using `dplyr` syntax

> Note: `collect()` will run a query that has been assigned to an object

```
covid_data_DBplyr_style %>% 
  collect()
```

Above will pull the whole data table down into your RAM.  You may want to avoid this.  Better to use dplyr to translate SQL querries to the SQL engine, summarizing and retrieving only the data you want to manipulate.


```{r}
jhu_covid19_DBP_nc_counties <- covid_data_DBplyr_style %>% 
  filter(province_state == "North Carolina", date == '2020-06-30')  %>% 
  select(province_state, country_region, date, latitude, 
         longitude, confirmed, deaths, #location_geom,
         recovered, active, fips, admin2, combined_key) 

jhu_covid19_DBP_nc_counties 
```

### show_query()

If you want to see the SQL

```{r}
jhu_covid19_DBP_nc_counties %>% 
  show_query()
```

### Variations

```{r}
glimpse(my_db_pointer)

my_search <- my_db_pointer %>% 
  filter(province_state == "North Carolina", date == '2020-06-30')  %>% 
  select(province_state, country_region, date, latitude, 
         longitude, confirmed, deaths, #location_geom,
         recovered, active, fips, admin2, combined_key)

my_search  

my_local_df <- my_search %>% 
  collect()
my_local_df

my_db_pointer %>% 
  filter(province_state == "North Carolina", date == '2020-06-30')  %>% 
  select(province_state, country_region, date, latitude, 
         longitude, confirmed, deaths, #location_geom,
         recovered, active, fips, admin2, combined_key)
```

### Collecting all the data into a local tibble

```{r}
jhu_covid19_durham_sinceApril <- covid_data_DBplyr_style %>% 
  filter(province_state == "North Carolina", 
         admin2 == "Durham",
         date >= '2020-04-01')  %>% 
  select(date, confirmed, deaths, recovered, active, 
         fips, admin2, combined_key) 

jhu_covid19_durham_sinceApril %>% 
  collect()
```


```{r}
jhu_covid19_durham_sinceApril %>% 
  arrange(date) 
```

### Visualize

```{r}
jhu_covid19_durham_sinceApril %>% 
  arrange(date) %>% 
  mutate(daily_count = deaths - lag(deaths)) %>% 
  filter(daily_count > -1) %>% 
  mutate(scare = case_when(
    daily_count >= 2 ~ "high",
    daily_count == 1 ~ "medium",
    daily_count == 0 ~ "low"
  )) %>% 
  ggplot(aes(date, daily_count, "low", "medium")) +
  geom_jitter(aes(color = fct_relevel(scare, "low", "medium"))) +
  geom_smooth(method = lm, se = FALSE) +
  geom_smooth(color = "red", se = FALSE) +
  scale_color_manual(values = c("forestgreen", "goldenrod", "firebrick")) +
  ylim(0, 5) +
  guides(color = FALSE) +
  labs(title = "Covid Deaths", subtitle = "daily count",
       y = "", x = "") +
  theme_classic()
```



```{r}
jhu_covid19_durham_sinceApril %>% 
  arrange(date) %>% 
  mutate(daily_count = confirmed - lag(confirmed)) %>% 
  mutate(scare = case_when(
    daily_count > 59 ~ "extreme",
    daily_count <= 59 & daily_count > 36  ~ "high",
    daily_count <= 36 & daily_count > 19 ~ "medium",
    daily_count <= 19 ~ "low"
  )) %>% 
  ggplot(aes(date, daily_count, "low", "medium")) +
  geom_point(aes(color = fct_relevel(scare, "low", "medium", "high", "extreme"))) +
  geom_smooth(method = lm, se = FALSE) +
  geom_smooth(color = "red", se = FALSE) +
  scale_color_manual(values = c("forestgreen", "goldenrod", "darkorange", "firebrick")) +
  scale_x_date(breaks = "1 month", date_labels = "%b") +
  guides(color = FALSE) +
  labs(title = "COVID19 Cases in Durham County, NC", 
       x = "", y = "daily county",
       caption = "Source: JHU dataset") +
  theme_classic()
```

```{r}
jhu_covid19_DBP_nc_counties %>% 
  select(admin2, fips, province_state, confirmed, deaths) %>% 
  rename(county = admin2, state = province_state, cases = confirmed) %>% 
  arrange(-deaths)
```

### SQL

```{sql connection=con, output.var = "special_df"}

SELECT `province_state`, `country_region`, `date`, 
       `latitude`, `longitude`, `confirmed`, `deaths`, 
       `recovered`, `active`, `fips`, `admin2`, `combined_key`
FROM `summary`
WHERE ((`province_state` = 'North Carolina') AND (`date` = '2020-06-30'))
```

Above code chunk created the tibble `special_df` as identified in output.var

```{r}
special_df %>% 
  ggplot(aes(confirmed, deaths)) +
  geom_jitter() +
  geom_text(data = . %>% filter(deaths > 100), 
            aes(confirmed, deaths, label = admin2, hjust = 1.15))
```

## DBplyr and Austin Bikeshare trips

Make the connection to the `bigquery-public-data.ustin_bikeshare` database

```{r}
con2_bq_bikes <- dbConnect(
  bigrquery::bigquery(),
  project = "bigquery-public-data",
  dataset = "austin_bikeshare",
  billing = "infra-radius-291118"
)
con2_bq_bikes
```

Set the query pointer to `bigquery-public-data.ustin_bikeshare.bikesahre_trips` table

```{r}
bikeshare_trips <- tbl(con2_bq_bikes, "bikeshare_trips") 
```



```{r}
austin_bikeshare_walkup <- bikeshare_trips %>% 
  mutate(trip_id = as.double(trip_id)) %>% 
  # select(trip_id:duration_minutes) %>% 
  filter(subscriber_type == "Walk Up") %>% 
  #        start_time <= "2016-01-01") %>% 
  # head(100000) %>%
  collect()
```


```{r}
austin_bikeshare_all <- bikeshare_trips %>% 
  mutate(trip_id = as.double(trip_id)) %>% 
  # filter(subscriber_type == "Walk Up") %>% 
  collect()
```


```{r}
austin_bikeshare_all
```

```
{r}
all_equal(austin_bikeshare_all, austin_trips)
```

```{r}
bigrquery::bq_table_fields("bigquery-public-data.austin_bikeshare.bikeshare_trips")
```



```{r}
glimpse(austin_bikeshare_all)
glimpse(bikeshare_trips)
```

[How far is to far to bike to work?](https://mobilitylab.org/2017/02/27/how-far-bike-work/)


```{r}
austin_bikeshare_all %>% 
  drop_na(subscriber_type) %>% 
  filter(duration_minutes < 100) %>%
  mutate(travel_type = case_when(
    duration_minutes <= 10 ~ "Commuter",
    duration_minutes >  10 ~ "Tourist"
  )) %>% 
  ggplot(aes(duration_minutes, fct_reorder(fct_lump(subscriber_type, prop = 0.01), duration_minutes))) +
  geom_boxplot(aes(fill = travel_type)) +
  geom_vline(xintercept = 10, linetype = "dashed", color = "grey60") +
  scale_x_log10() +
  labs(title = "Bike Share Trip times", 
       subtitle = "Austin BikeShare Program",
       y = "Type of bike rental pass",
       x = "Duration of ride in minutes",
       caption = "Source: Public datasets > Google BigQuery > Austin Bikeshare Trips",
       fill = "") 
```

```{r}
summary(austin_bikeshare_all)
```

## Example

List the top 5 percent of stations where bikeshare trips begin and end

```{r}
left_tbl <- bikeshare_trips %>% 
  count(start_station_name) %>% 
  slice_max(order_by = n, prop = .05)
left_tbl

right_tbl <- bikeshare_trips %>% 
  count(end_station_name) %>% 
  slice_max(order_by = n, prop = .05)
right_tbl

left_join(left_tbl, right_tbl, by = c("start_station_name" = "end_station_name")) # %>% show_query()
```

```{r}

```


## Resources

- [Databases using R](https://db.rstudio.com/)
- [library(DBI)](https://dbi.r-dbi.org/reference/)
- [library(bigrquery)](https://bigrquery.r-dbi.org/)
- [library(dbplyr)](https://dbplyr.tidyverse.org/)
- [RStudio Conf 2019, 15 min. Recording](https://rstudio.com/resources/rstudioconf-2019/databases-using-r-the-latest/)
